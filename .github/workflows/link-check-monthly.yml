name: üîó Verifica√ß√£o Mensal de Links

on:
  schedule:
    # Executa no dia 1 de cada m√™s √†s 9:00 UTC (6:00 BRT)
    - cron: '0 9 1 * *'
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  link-check:
    name: Verificar Links Quebrados
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Instalar depend√™ncias
        run: npm ci

      - name: üîó Verificar links
        id: link_check
        continue-on-error: true
        run: |
          echo "## üîó Relat√≥rio de Links Quebrados" > link-report.md
          echo "" >> link-report.md
          echo "**Data da verifica√ß√£o:** $(date '+%d/%m/%Y √†s %H:%M UTC')" >> link-report.md
          echo "" >> link-report.md

          # Roda link check e captura output
          if NODE_NO_WARNINGS=1 npm run link-check > link-output.txt 2>&1; then
            echo "‚úÖ Nenhum link quebrado encontrado!" >> link-report.md
            echo "has_broken_links=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è **Links quebrados encontrados:**" >> link-report.md
            echo "" >> link-report.md
            echo '```' >> link-report.md
            cat link-output.txt | grep -A 5 "‚úñ" >> link-report.md || true
            echo '```' >> link-report.md
            echo "has_broken_links=true" >> $GITHUB_OUTPUT
          fi

      - name: üìä Upload do relat√≥rio como artifact
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report-${{ github.run_number }}
          path: link-report.md
          retention-days: 90

      - name: üêõ Criar issue com links quebrados
        if: steps.link_check.outputs.has_broken_links == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('link-report.md', 'utf8');

            // Verifica se j√° existe issue aberta
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'links-quebrados,automated'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Links Quebrados - Verifica√ß√£o Mensal')
            );

            if (existingIssue) {
              // Atualiza issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## üîÑ Nova verifica√ß√£o realizada\n\n${report}\n\n---\n*Verifica√ß√£o autom√°tica executada em ${new Date().toLocaleString('pt-BR')}*`
              });

              console.log(`Issue #${existingIssue.number} atualizada com novo relat√≥rio`);
            } else {
              // Cria nova issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üîó Links Quebrados - Verifica√ß√£o Mensal',
                body: `${report}\n\n---\n\n### üìù Pr√≥ximos Passos\n\n- [ ] Revisar todos os links quebrados\n- [ ] Atualizar ou remover links mortos\n- [ ] Verificar se h√° URLs alternativas\n- [ ] Fechar esta issue ap√≥s corre√ß√£o\n\n---\n*Issue criada automaticamente pela verifica√ß√£o mensal de links*\n*Pr√≥xima verifica√ß√£o: Dia 1 do pr√≥ximo m√™s*`,
                labels: ['links-quebrados', 'automated', 'maintenance']
              });

              console.log(`Issue #${issue.data.number} criada com sucesso`);
            }

      - name: ‚úÖ Comentar no commit se tudo OK
        if: steps.link_check.outputs.has_broken_links == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Opcional: pode enviar notifica√ß√£o ou comentar em algum lugar
            console.log('‚úÖ Verifica√ß√£o mensal conclu√≠da: nenhum link quebrado!');
