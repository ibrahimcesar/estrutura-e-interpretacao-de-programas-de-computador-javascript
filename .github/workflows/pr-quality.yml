name: üîç PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  pr-metadata:
    name: üìä An√°lise de PR
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìè Calcular tamanho do PR
        id: pr-size
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            let additions = 0;
            let deletions = 0;
            let changedFiles = files.length;

            files.forEach(file => {
              additions += file.additions;
              deletions += file.deletions;
            });

            const totalChanges = additions + deletions;
            let sizeLabel = '';

            // Determinar tamanho do PR
            if (totalChanges < 10) {
              sizeLabel = 'size/XS';
            } else if (totalChanges < 50) {
              sizeLabel = 'size/S';
            } else if (totalChanges < 250) {
              sizeLabel = 'size/M';
            } else if (totalChanges < 1000) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }

            core.setOutput('size-label', sizeLabel);
            core.setOutput('additions', additions);
            core.setOutput('deletions', deletions);
            core.setOutput('changed-files', changedFiles);
            core.setOutput('total-changes', totalChanges);

      - name: üè∑Ô∏è Adicionar label de tamanho
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sizeLabel = '${{ steps.pr-size.outputs.size-label }}';
            const allSizeLabels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];

            // Remover labels de tamanho anteriores
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            for (const label of currentLabels) {
              if (allSizeLabels.includes(label.name) && label.name !== sizeLabel) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label.name,
                });
              }
            }

            // Adicionar nova label de tamanho
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel],
            });

      - name: üè∑Ô∏è Auto-labeling por tipo de arquivo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = new Set();

            // An√°lise dos arquivos modificados
            for (const file of files) {
              const filename = file.filename;

              // Documenta√ß√£o
              if (filename.endsWith('.md')) {
                labels.add('documentation');
              }

              // Tradu√ß√£o
              if (filename.includes('/docs/') && filename.endsWith('.md')) {
                labels.add('tradu√ß√£o');
              }

              // GitHub Actions / Workflows
              if (filename.includes('.github/workflows/')) {
                labels.add('github-actions');
              }

              // Depend√™ncias
              if (filename === 'package.json' || filename === 'package-lock.json') {
                labels.add('dependencies');
              }

              // Configura√ß√£o
              if (filename.includes('config') || filename === 'Makefile' ||
                  filename === '.editorconfig' || filename === '.nvmrc') {
                labels.add('configuration');
              }

              // CSS/Styling
              if (filename.endsWith('.css') || filename.endsWith('.scss')) {
                labels.add('styling');
              }

              // JavaScript/TypeScript
              if (filename.endsWith('.js') || filename.endsWith('.jsx') ||
                  filename.endsWith('.ts') || filename.endsWith('.tsx')) {
                labels.add('javascript');
              }

              // Imagens/Assets
              if (filename.match(/\.(png|jpg|jpeg|gif|svg|ico|webp)$/i)) {
                labels.add('assets');
              }
            }

            // Adicionar labels identificadas
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels),
              });
            }

      - name: üí¨ Comentar resumo do PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const additions = '${{ steps.pr-size.outputs.additions }}';
            const deletions = '${{ steps.pr-size.outputs.deletions }}';
            const changedFiles = '${{ steps.pr-size.outputs.changed-files }}';
            const totalChanges = '${{ steps.pr-size.outputs.total-changes }}';
            const sizeLabel = '${{ steps.pr-size.outputs.size-label }}';

            // Emoji baseado no tamanho
            let sizeEmoji = 'üì¶';
            if (sizeLabel === 'size/XS') sizeEmoji = 'üß©';
            if (sizeLabel === 'size/S') sizeEmoji = 'üì¶';
            if (sizeLabel === 'size/M') sizeEmoji = 'üìö';
            if (sizeLabel === 'size/L') sizeEmoji = 'üéØ';
            if (sizeLabel === 'size/XL') sizeEmoji = 'üé™';

            // Dica baseada no tamanho
            let tip = '';
            if (sizeLabel === 'size/XL') {
              tip = '\n\n> üí° **Dica**: Este PR √© muito grande. Considere dividi-lo em PRs menores para facilitar a revis√£o.';
            } else if (sizeLabel === 'size/L') {
              tip = '\n\n> ‚ÑπÔ∏è Este √© um PR grande. A revis√£o pode levar mais tempo.';
            }

            const comment = `## ${sizeEmoji} An√°lise Autom√°tica do PR

**Tamanho**: \`${sizeLabel}\`

| M√©trica | Valor |
|---------|-------|
| ‚ûï Adi√ß√µes | ${additions} |
| ‚ûñ Remo√ß√µes | ${deletions} |
| üìù Arquivos modificados | ${changedFiles} |
| üî¢ Total de mudan√ßas | ${totalChanges} |
${tip}

---
*An√°lise autom√°tica gerada pelo workflow de qualidade*`;

            // Verificar se j√° existe coment√°rio
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('An√°lise Autom√°tica do PR')
            );

            if (botComment) {
              // Atualizar coment√°rio existente
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              // Criar novo coment√°rio
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

  check-status:
    name: üìã Status de Verifica√ß√µes
    runs-on: ubuntu-latest
    needs: pr-metadata
    if: always()

    steps:
      - name: üí¨ Comentar status das verifica√ß√µes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Esperar um pouco para que os outros workflows iniciem
            await new Promise(resolve => setTimeout(resolve, 10000));

            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });

            let lintStatus = '‚è≥ Aguardando';
            let spellStatus = '‚è≥ Aguardando';
            let linkStatus = '‚è≥ Aguardando';

            for (const run of checkRuns.check_runs) {
              const name = run.name.toLowerCase();
              const status = run.status;
              const conclusion = run.conclusion;

              let emoji = '‚è≥';
              if (status === 'completed') {
                emoji = conclusion === 'success' ? '‚úÖ' : '‚ùå';
              }

              if (name.includes('markdown') || name.includes('lint')) {
                lintStatus = `${emoji} ${run.name}`;
              } else if (name.includes('spell')) {
                spellStatus = `${emoji} ${run.name}`;
              } else if (name.includes('link')) {
                linkStatus = `${emoji} ${run.name}`;
              }
            }

            console.log(`Lint: ${lintStatus}`);
            console.log(`Spell: ${spellStatus}`);
            console.log(`Link: ${linkStatus}`);
