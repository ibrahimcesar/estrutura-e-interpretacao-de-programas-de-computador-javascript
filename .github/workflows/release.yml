name: ğŸš€ Release Automation

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Tipo de versÃ£o (major, minor, patch)'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Ã‰ um pre-release?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: ğŸ‰ Criar Release
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          npm install --save-dev conventional-changelog-cli

      - name: ğŸ“Š Obter versÃ£o atual
        id: current_version
        run: |
          current=$(node -p "require('./package.json').version")
          echo "version=$current" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ VersÃ£o atual: $current"

      - name: ğŸ”¢ Calcular nova versÃ£o
        id: new_version
        run: |
          current="${{ steps.current_version.outputs.version }}"
          IFS='.' read -ra parts <<< "$current"

          major=${parts[0]}
          minor=${parts[1]}
          patch=${parts[2]}

          case "${{ github.event.inputs.version }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_version="$major.$minor.$patch"

          if [ "${{ github.event.inputs.prerelease }}" == "true" ]; then
            new_version="$new_version-beta.$(date +%Y%m%d%H%M%S)"
          fi

          echo "version=$new_version" >> $GITHUB_OUTPUT
          echo "ğŸ†• Nova versÃ£o: $new_version"

      - name: ğŸ“ Atualizar package.json
        run: |
          npm version ${{ steps.new_version.outputs.version }} --no-git-tag-version
          echo "âœ… package.json atualizado para v${{ steps.new_version.outputs.version }}"

      - name: ğŸ“‹ Gerar CHANGELOG
        run: |
          # Gerar changelog desde Ãºltima tag
          npx conventional-changelog -p angular -i CHANGELOG.md -s

          echo "âœ… CHANGELOG atualizado"

      - name: ğŸ“Š Gerar Release Notes
        id: release_notes
        run: |
          # Obter Ãºltima tag
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$last_tag" ]; then
            # Primeira release
            commits=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Commits desde Ãºltima tag
            commits=$(git log ${last_tag}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Categorizar commits
          features=$(echo "$commits" | grep "feat:" || echo "")
          fixes=$(echo "$commits" | grep "fix:" || echo "")
          docs=$(echo "$commits" | grep "docs:" || echo "")
          chores=$(echo "$commits" | grep "chore:" || echo "")
          other=$(echo "$commits" | grep -v "feat:\|fix:\|docs:\|chore:" || echo "")

          # Criar release notes
          cat > release-notes.md << EOF
          # ğŸ‰ SICP.js PT-BR v${{ steps.new_version.outputs.version }}

          ## ğŸ“‹ Resumo

          Release da traduÃ§Ã£o em portuguÃªs do SICP.js.

          EOF

          if [ -n "$features" ]; then
            cat >> release-notes.md << EOF

          ## âœ¨ Novas Funcionalidades

          $features

          EOF
          fi

          if [ -n "$fixes" ]; then
            cat >> release-notes.md << EOF

          ## ğŸ› CorreÃ§Ãµes

          $fixes

          EOF
          fi

          if [ -n "$docs" ]; then
            cat >> release-notes.md << EOF

          ## ğŸ“š DocumentaÃ§Ã£o

          $docs

          EOF
          fi

          if [ -n "$chores" ]; then
            cat >> release-notes.md << EOF

          ## ğŸ”§ ManutenÃ§Ã£o

          $chores

          EOF
          fi

          if [ -n "$other" ]; then
            cat >> release-notes.md << EOF

          ## ğŸ“¦ Outras MudanÃ§as

          $other

          EOF
          fi

          cat >> release-notes.md << 'EOF'

          ## ğŸ“– Como Usar

          Acesse o site: [sicpjs.com/pt_BR](https://sicpjs.com/pt_BR)

          ## ğŸ¤ Contribuidores

          Agradecemos a todos os contribuidores que tornaram esta release possÃ­vel!

          ---

          **InstalaÃ§Ã£o Local**:
          \`\`\`bash
          git clone https://github.com/ibrahimcesar/estrutura-e-interpretacao-de-programas-de-computador-javascript.git
          cd estrutura-e-interpretacao-de-programas-de-computador-javascript
          npm install
          npm start
          \`\`\`

          **Changelog Completo**: Ver [CHANGELOG.md](CHANGELOG.md)

          EOF

          echo "âœ… Release notes geradas"

      - name: ğŸ’¾ Commit mudanÃ§as
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json package-lock.json CHANGELOG.md
          git commit -m "ğŸ”– chore(release): v${{ steps.new_version.outputs.version }}

          Automated release commit.

          - Update package.json version
          - Update CHANGELOG.md
          - Generate release notes

          ğŸ¤– Generated by Release Automation"

      - name: ğŸ·ï¸ Criar tag
        run: |
          git tag -a "v${{ steps.new_version.outputs.version }}" -m "Release v${{ steps.new_version.outputs.version }}"
          echo "âœ… Tag v${{ steps.new_version.outputs.version }} criada"

      - name: ğŸš€ Push mudanÃ§as e tag
        run: |
          git push origin main
          git push origin "v${{ steps.new_version.outputs.version }}"
          echo "âœ… MudanÃ§as e tag enviadas"

      - name: ğŸ‰ Criar GitHub Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release-notes.md', 'utf8');

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: 'v${{ steps.new_version.outputs.version }}',
              name: 'v${{ steps.new_version.outputs.version }}',
              body: releaseNotes,
              draft: false,
              prerelease: ${{ github.event.inputs.prerelease }}
            });

            console.log(`âœ… Release criada: ${release.data.html_url}`);

            // Criar discussÃ£o de anÃºncio
            try {
              const discussion = await github.graphql(`
                mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                  createDiscussion(input: {
                    repositoryId: $repositoryId,
                    categoryId: $categoryId,
                    title: $title,
                    body: $body
                  }) {
                    discussion {
                      url
                    }
                  }
                }
              `, {
                repositoryId: context.payload.repository.node_id,
                categoryId: 'ANNOUNCEMENTS_CATEGORY_ID', // Substituir pelo ID real
                title: `ğŸ‰ v${{ steps.new_version.outputs.version }} Released!`,
                body: `${releaseNotes}\n\n[Ver Release no GitHub](${release.data.html_url})`
              });

              console.log('âœ… DiscussÃ£o de anÃºncio criada');
            } catch (e) {
              console.log('âš ï¸ NÃ£o foi possÃ­vel criar discussÃ£o (pode nÃ£o estar configurado)');
            }

      - name: âœ… Resumo
        run: |
          echo "ğŸ‰ Release v${{ steps.new_version.outputs.version }} criada com sucesso!"
          echo ""
          echo "ğŸ“‹ Resumo:"
          echo "  - VersÃ£o anterior: ${{ steps.current_version.outputs.version }}"
          echo "  - Nova versÃ£o: ${{ steps.new_version.outputs.version }}"
          echo "  - Tipo: ${{ github.event.inputs.version }}"
          echo "  - Pre-release: ${{ github.event.inputs.prerelease }}"
          echo ""
          echo "ğŸ”— PrÃ³ximos passos:"
          echo "  - Verificar release no GitHub"
          echo "  - Anunciar nas redes sociais"
          echo "  - Atualizar documentaÃ§Ã£o externa (se necessÃ¡rio)"
