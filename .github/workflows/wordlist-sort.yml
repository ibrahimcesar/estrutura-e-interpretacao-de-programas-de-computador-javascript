name: ğŸ“ Auto-Sort Wordlist

on:
  pull_request:
    paths:
      - '.github/wordlist.txt'
  push:
    branches:
      - main
    paths:
      - '.github/wordlist.txt'

permissions:
  contents: write
  pull-requests: write

jobs:
  sort-wordlist:
    name: ğŸ”¤ Ordenar Wordlist
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Verificar se wordlist precisa ser ordenada
        id: check
        run: |
          # Fazer backup da wordlist original
          cp .github/wordlist.txt .github/wordlist.txt.backup

          # Executar script de ordenaÃ§Ã£o
          bash .github/reorder-wordlist.sh

          # Verificar se houve mudanÃ§as
          if diff -q .github/wordlist.txt .github/wordlist.txt.backup > /dev/null; then
            echo "needs_sort=false" >> $GITHUB_OUTPUT
            echo "âœ… Wordlist jÃ¡ estÃ¡ ordenada corretamente"
          else
            echo "needs_sort=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Wordlist precisa ser ordenada"
          fi

          # Remover backup
          rm .github/wordlist.txt.backup

      - name: ğŸ“Š Mostrar diferenÃ§as
        if: steps.check.outputs.needs_sort == 'true'
        run: |
          echo "MudanÃ§as na wordlist:"
          git diff .github/wordlist.txt || true

      - name: ğŸ’¾ Commit wordlist ordenada
        if: steps.check.outputs.needs_sort == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .github/wordlist.txt

          git commit -m "ğŸ”§ chore: ordenar wordlist automaticamente

          A wordlist foi automaticamente ordenada e deduplicada pelo script reorder-wordlist.sh

          ğŸ¤– Generated by GitHub Actions"

      - name: ğŸš€ Push mudanÃ§as
        if: steps.check.outputs.needs_sort == 'true' && github.event_name == 'pull_request'
        run: |
          git push origin HEAD:${{ github.head_ref }}

      - name: ğŸš€ Push mudanÃ§as (main)
        if: steps.check.outputs.needs_sort == 'true' && github.event_name == 'push'
        run: |
          git push

      - name: ğŸ’¬ Comentar no PR
        if: steps.check.outputs.needs_sort == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ğŸ”¤ Wordlist Auto-Sorted

            A wordlist foi automaticamente ordenada e deduplicada.

            ### âœ… MudanÃ§as Aplicadas

            - ComentÃ¡rios preservados no topo
            - Palavras ordenadas alfabeticamente
            - Duplicatas removidas
            - Linhas vazias removidas

            Estas mudanÃ§as foram commitadas automaticamente neste PR.

            ---
            *AutomaÃ§Ã£o executada por \`.github/reorder-wordlist.sh\`*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment,
            });

      - name: âœ… Resumo
        run: |
          if [ "${{ steps.check.outputs.needs_sort }}" == "true" ]; then
            echo "âœ… Wordlist foi ordenada e commitada automaticamente"
          else
            echo "âœ… Wordlist jÃ¡ estava ordenada corretamente"
          fi

  validate-wordlist:
    name: âœ… Validar Wordlist
    runs-on: ubuntu-latest
    needs: sort-wordlist

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}

      - name: ğŸ” Validar formato da wordlist
        run: |
          echo "Validando formato da wordlist..."

          # Verificar se arquivo existe
          if [ ! -f .github/wordlist.txt ]; then
            echo "âŒ Erro: .github/wordlist.txt nÃ£o encontrado"
            exit 1
          fi

          # Verificar se tem conteÃºdo
          if [ ! -s .github/wordlist.txt ]; then
            echo "âŒ Erro: wordlist estÃ¡ vazia"
            exit 1
          fi

          # Verificar se estÃ¡ ordenada (ignorando comentÃ¡rios)
          if ! sed '/^#/d;/^$/d' .github/wordlist.txt | sort -c 2>/dev/null; then
            echo "âŒ Erro: wordlist nÃ£o estÃ¡ ordenada corretamente"
            echo "Execute: .github/reorder-wordlist.sh"
            exit 1
          fi

          # Verificar duplicatas (ignorando comentÃ¡rios)
          duplicates=$(sed '/^#/d;/^$/d' .github/wordlist.txt | sort | uniq -d)
          if [ -n "$duplicates" ]; then
            echo "âŒ Erro: palavras duplicadas encontradas:"
            echo "$duplicates"
            exit 1
          fi

          # Contar palavras
          word_count=$(sed '/^#/d;/^$/d' .github/wordlist.txt | wc -l)
          echo "âœ… Wordlist vÃ¡lida: $word_count palavras"

      - name: ğŸ“Š EstatÃ­sticas da wordlist
        run: |
          echo "ğŸ“Š EstatÃ­sticas da Wordlist:"
          echo "=========================="

          total_lines=$(wc -l < .github/wordlist.txt)
          comments=$(grep -c '^#' .github/wordlist.txt || echo 0)
          blank_lines=$(grep -c '^$' .github/wordlist.txt || echo 0)
          words=$(sed '/^#/d;/^$/d' .github/wordlist.txt | wc -l)

          echo "Linhas totais: $total_lines"
          echo "ComentÃ¡rios: $comments"
          echo "Linhas vazias: $blank_lines"
          echo "Palavras: $words"
