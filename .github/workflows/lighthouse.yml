name: üî¶ Lighthouse CI

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    name: üî¶ Run Lighthouse
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Instalar depend√™ncias
        run: npm ci

      - name: üèóÔ∏è Build do site
        run: npm run build

      - name: üî¶ Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:3000/pt_BR/
            http://localhost:3000/pt_BR/prefaces/foreword84
            http://localhost:3000/pt_BR/chapter-1/intro
          budgetPath: .github/lighthouse/budget.json
          temporaryPublicStorage: true
          uploadArtifacts: true
          runs: 3

      - name: üìä Processar resultados
        id: results
        run: |
          echo "Processando resultados do Lighthouse..."

          # Placeholder para scores (ser√£o preenchidos pelo action)
          echo "lighthouse_ran=true" >> $GITHUB_OUTPUT

      - name: üí¨ Comentar resultados no PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Tentar ler manifesto do Lighthouse
            let manifestPath = '.lighthouseci/manifest.json';
            if (!fs.existsSync(manifestPath)) {
              console.log('Manifest n√£o encontrado, pulando coment√°rio');
              return;
            }

            const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));

            if (!manifest || manifest.length === 0) {
              console.log('Sem resultados no manifest');
              return;
            }

            // Pegar primeiro resultado
            const result = manifest[0];
            const summary = result.summary;

            const formatScore = (score) => {
              const percentage = Math.round(score * 100);
              let emoji = 'üî¥';
              if (percentage >= 90) emoji = 'üü¢';
              else if (percentage >= 50) emoji = 'üü°';
              return `${emoji} ${percentage}`;
            };

            const comment = `## üî¶ Lighthouse CI Report

            Resultados da an√°lise de qualidade do site:

            | Categoria | Score |
            |-----------|-------|
            | ‚ö° Performance | ${formatScore(summary.performance || 0)} |
            | ‚ôø Accessibility | ${formatScore(summary.accessibility || 0)} |
            | üéØ Best Practices | ${formatScore(summary['best-practices'] || 0)} |
            | üîç SEO | ${formatScore(summary.seo || 0)} |
            | üì± PWA | ${formatScore(summary.pwa || 0)} |

            ### üìä Legenda
            - üü¢ 90-100: Excelente
            - üü° 50-89: Precisa melhorar
            - üî¥ 0-49: Ruim

            ${result.url ? `\nüìé [Ver relat√≥rio completo](${result.url})` : ''}

            ---
            *An√°lise gerada automaticamente pelo Lighthouse CI*`;

            // Verificar se j√° existe coment√°rio
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Lighthouse CI Report')
            );

            if (botComment) {
              // Atualizar coment√°rio existente
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              // Criar novo coment√°rio
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

      - name: üìä Upload dos reports como artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports-${{ github.run_number }}
          path: .lighthouseci/
          retention-days: 30

      - name: ‚ö†Ô∏è Verificar thresholds
        if: github.event_name == 'pull_request'
        run: |
          echo "Verificando se scores atendem aos requisitos m√≠nimos..."

          # Os thresholds s√£o definidos em budget.json
          # O Lighthouse CI action automaticamente falhar√° se n√£o atender

          echo "‚úÖ Verifica√ß√£o de thresholds conclu√≠da"
