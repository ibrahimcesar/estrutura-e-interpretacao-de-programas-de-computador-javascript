name: ğŸ“Š Rastreamento de Progresso da TraduÃ§Ã£o

on:
  schedule:
    # Executa toda segunda-feira Ã s 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Permite execuÃ§Ã£o manual
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'

permissions:
  contents: write
  issues: write
  pull-requests: read

jobs:
  calculate-progress:
    name: ğŸ“ˆ Calcular Progresso
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Analisar progresso da traduÃ§Ã£o
        id: progress
        run: |
          echo "Analisando arquivos Markdown (.md e .mdx) em docs/..."

          # Contar total de arquivos .md e .mdx, excluindo arquivos de infraestrutura
          total_files=$(find docs/chapter-* docs/prefaces -name "*.md" -o -name "*.mdx" | \
            grep -vE "(_snippets|guia-traducao|como-contribuir|TRANSLATION_STATUS|README)" | wc -l)

          # Contar palavras totais (apenas arquivos do livro)
          total_words=$(find docs/chapter-* docs/prefaces -name "*.md" -o -name "*.mdx" | \
            grep -vE "(_snippets|guia-traducao|como-contribuir|TRANSLATION_STATUS|README)" | \
            xargs cat 2>/dev/null | wc -w)

          # Contar arquivos por capÃ­tulo (.md e .mdx)
          ch1_files=$(find docs/chapter-1 -name "*.md" -o -name "*.mdx" 2>/dev/null | wc -l || echo 0)
          ch2_files=$(find docs/chapter-2 -name "*.md" -o -name "*.mdx" 2>/dev/null | wc -l || echo 0)
          ch3_files=$(find docs/chapter-3 -name "*.md" -o -name "*.mdx" 2>/dev/null | wc -l || echo 0)
          ch4_files=$(find docs/chapter-4 -name "*.md" -o -name "*.mdx" 2>/dev/null | \
            grep -v "TRANSLATION_STATUS" | wc -l || echo 0)
          ch5_files=$(find docs/chapter-5 -name "*.md" -o -name "*.mdx" 2>/dev/null | wc -l || echo 0)
          prefaces_files=$(find docs/prefaces -name "*.md" -o -name "*.mdx" 2>/dev/null | wc -l || echo 0)

          # Palavras por capÃ­tulo (.md e .mdx)
          ch1_words=$(find docs/chapter-1 \( -name "*.md" -o -name "*.mdx" \) -type f -exec cat {} \; 2>/dev/null | wc -w || echo 0)
          ch2_words=$(find docs/chapter-2 \( -name "*.md" -o -name "*.mdx" \) -type f -exec cat {} \; 2>/dev/null | wc -w || echo 0)
          ch3_words=$(find docs/chapter-3 \( -name "*.md" -o -name "*.mdx" \) -type f -exec cat {} \; 2>/dev/null | wc -w || echo 0)
          ch4_words=$(find docs/chapter-4 \( -name "*.md" -o -name "*.mdx" \) -type f -exec cat {} \; 2>/dev/null | wc -w || echo 0)
          ch5_words=$(find docs/chapter-5 \( -name "*.md" -o -name "*.mdx" \) -type f -exec cat {} \; 2>/dev/null | wc -w || echo 0)
          prefaces_words=$(find docs/prefaces \( -name "*.md" -o -name "*.mdx" \) -type f -exec cat {} \; 2>/dev/null | wc -w || echo 0)

          # Estimativa de progresso
          # SICP JS tem aproximadamente 120 seÃ§Ãµes (CapÃ­tulos 1-5 + PrefÃ¡cios)
          # Baseado em: Caps 1-4 = ~94 seÃ§Ãµes, Cap 5 = ~23 seÃ§Ãµes (estimado), PrefÃ¡cios = 3
          estimated_total_files=120
          progress_percent=$(( (total_files * 100) / estimated_total_files ))

          # Salvar outputs
          echo "total_files=$total_files" >> $GITHUB_OUTPUT
          echo "total_words=$total_words" >> $GITHUB_OUTPUT
          echo "progress_percent=$progress_percent" >> $GITHUB_OUTPUT
          echo "ch1_files=$ch1_files" >> $GITHUB_OUTPUT
          echo "ch2_files=$ch2_files" >> $GITHUB_OUTPUT
          echo "ch3_files=$ch3_files" >> $GITHUB_OUTPUT
          echo "ch4_files=$ch4_files" >> $GITHUB_OUTPUT
          echo "ch5_files=$ch5_files" >> $GITHUB_OUTPUT
          echo "prefaces_files=$prefaces_files" >> $GITHUB_OUTPUT
          echo "ch1_words=$ch1_words" >> $GITHUB_OUTPUT
          echo "ch2_words=$ch2_words" >> $GITHUB_OUTPUT
          echo "ch3_words=$ch3_words" >> $GITHUB_OUTPUT
          echo "ch4_words=$ch4_words" >> $GITHUB_OUTPUT
          echo "ch5_words=$ch5_words" >> $GITHUB_OUTPUT
          echo "prefaces_words=$prefaces_words" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Progresso calculado: $progress_percent%"
          echo "ğŸ“ Total de arquivos: $total_files"
          echo "ğŸ“– Total de palavras: $total_words"

      - name: ğŸ“ Gerar relatÃ³rio de progresso
        id: report
        run: |
          cat > progress-report.md << 'EOF'
          # ğŸ“Š RelatÃ³rio de Progresso da TraduÃ§Ã£o SICP.js PT-BR

          **Data**: $(date '+%d/%m/%Y')

          ## ğŸ“ˆ VisÃ£o Geral

          - **Progresso estimado**: ${{ steps.progress.outputs.progress_percent }}%
          - **Arquivos traduzidos**: ${{ steps.progress.outputs.total_files }}
          - **Total de palavras**: ${{ steps.progress.outputs.total_words }}

          ## ğŸ“š Progresso por CapÃ­tulo

          | CapÃ­tulo | Arquivos | Palavras |
          |----------|----------|----------|
          | PrefÃ¡cios | ${{ steps.progress.outputs.prefaces_files }} | ${{ steps.progress.outputs.prefaces_words }} |
          | CapÃ­tulo 1: Construindo AbstraÃ§Ãµes com FunÃ§Ãµes | ${{ steps.progress.outputs.ch1_files }} | ${{ steps.progress.outputs.ch1_words }} |
          | CapÃ­tulo 2: Construindo AbstraÃ§Ãµes com Dados | ${{ steps.progress.outputs.ch2_files }} | ${{ steps.progress.outputs.ch2_words }} |
          | CapÃ­tulo 3: Modularidade, Objetos e Estado | ${{ steps.progress.outputs.ch3_files }} | ${{ steps.progress.outputs.ch3_words }} |
          | CapÃ­tulo 4: Avaliadores MetalinguÃ­sticos | ${{ steps.progress.outputs.ch4_files }} | ${{ steps.progress.outputs.ch4_words }} |
          | CapÃ­tulo 5: ComputaÃ§Ã£o com MÃ¡quinas de Registradores | ${{ steps.progress.outputs.ch5_files }} | ${{ steps.progress.outputs.ch5_words }} |

          ## ğŸ“Š Barra de Progresso

          ${{ steps.progress.outputs.progress_percent }}% concluÃ­do

          ```
          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ ${{ steps.progress.outputs.progress_percent }}%
          ```

          ## ğŸ¯ PrÃ³ximas Etapas

          - [ ] Completar capÃ­tulo atual
          - [ ] Revisar traduÃ§Ãµes existentes
          - [ ] Adicionar exemplos interativos

          ## ğŸ¤ Como Contribuir

          Quer ajudar a acelerar o progresso? Veja nosso [Guia de ContribuiÃ§Ã£o](CONTRIBUTING.md)!

          ---
          *RelatÃ³rio gerado automaticamente em $(date '+%d/%m/%Y %H:%M:%S UTC')*
          EOF

      - name: ğŸ’¾ Upload do relatÃ³rio como artifact
        uses: actions/upload-artifact@v4
        with:
          name: translation-progress-report-${{ github.run_number }}
          path: progress-report.md
          retention-days: 90

      - name: ğŸ“Š Atualizar ou criar issue de progresso
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const progressPercent = '${{ steps.progress.outputs.progress_percent }}';
            const totalFiles = '${{ steps.progress.outputs.total_files }}';
            const totalWords = '${{ steps.progress.outputs.total_words }}';

            const today = new Date().toLocaleDateString('pt-BR');

            // Buscar issue de progresso existente
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'progresso-traduÃ§Ã£o,automated',
            });

            const progressIssue = issues.find(issue =>
              issue.title.includes('Progresso da TraduÃ§Ã£o')
            );

            const reportBody = `## ğŸ“Š AtualizaÃ§Ã£o de Progresso - ${today}

            ### ğŸ“ˆ Resumo

            - **Progresso estimado**: ${progressPercent}%
            - **Arquivos traduzidos**: ${totalFiles}
            - **Total de palavras**: ${totalWords}

            ### ğŸ“š Progresso por CapÃ­tulo

            | CapÃ­tulo | Arquivos | Palavras |
            |----------|----------|----------|
            | PrefÃ¡cios | ${{ steps.progress.outputs.prefaces_files }} | ${{ steps.progress.outputs.prefaces_words }} |
            | CapÃ­tulo 1: Construindo AbstraÃ§Ãµes com FunÃ§Ãµes | ${{ steps.progress.outputs.ch1_files }} | ${{ steps.progress.outputs.ch1_words }} |
            | CapÃ­tulo 2: Construindo AbstraÃ§Ãµes com Dados | ${{ steps.progress.outputs.ch2_files }} | ${{ steps.progress.outputs.ch2_words }} |
            | CapÃ­tulo 3: Modularidade, Objetos e Estado | ${{ steps.progress.outputs.ch3_files }} | ${{ steps.progress.outputs.ch3_words }} |
            | CapÃ­tulo 4: Avaliadores MetalinguÃ­sticos | ${{ steps.progress.outputs.ch4_files }} | ${{ steps.progress.outputs.ch4_words }} |
            | CapÃ­tulo 5: ComputaÃ§Ã£o com MÃ¡quinas de Registradores | ${{ steps.progress.outputs.ch5_files }} | ${{ steps.progress.outputs.ch5_words }} |

            ### ğŸ“Š Barra de Progresso

            \`\`\`
            ${'â–ˆ'.repeat(Math.floor(progressPercent / 2.5))}${'â–‘'.repeat(40 - Math.floor(progressPercent / 2.5))} ${progressPercent}%
            \`\`\`

            ### ğŸ¯ Como Contribuir

            Quer ajudar a acelerar o progresso?

            1. Veja as [issues abertas com label "traduÃ§Ã£o"](https://github.com/ibrahimcesar/estrutura-e-interpretacao-de-programas-de-computador-javascript/labels/traduÃ§Ã£o)
            2. Escolha uma seÃ§Ã£o para traduzir
            3. Leia o [Guia de TraduÃ§Ã£o](TRANSLATION.md)
            4. Envie seu PR!

            ---
            *AtualizaÃ§Ã£o automÃ¡tica gerada em ${today}*`;

            if (progressIssue) {
              // Atualizar issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: progressIssue.number,
                body: reportBody,
              });
              console.log(`Issue #${progressIssue.number} atualizada com novo progresso`);
            } else {
              // Criar nova issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“Š Progresso da TraduÃ§Ã£o - Acompanhamento',
                body: `${reportBody}\n\n---\n\n**Esta issue Ã© atualizada automaticamente toda segunda-feira.**\n\nAcompanhe o progresso da traduÃ§Ã£o do SICP.js para portuguÃªs!`,
                labels: ['progresso-traduÃ§Ã£o', 'automated', 'pinned'],
              });
              console.log(`Issue #${issue.data.number} criada com relatÃ³rio de progresso`);
            }

      - name: âœ… Resumo
        run: |
          echo "âœ… AnÃ¡lise de progresso concluÃ­da!"
          echo "ğŸ“Š Progresso: ${{ steps.progress.outputs.progress_percent }}%"
          echo "ğŸ“ Arquivos: ${{ steps.progress.outputs.total_files }}"
          echo "ğŸ“– Palavras: ${{ steps.progress.outputs.total_words }}"
