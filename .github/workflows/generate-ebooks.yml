name: ğŸ“š Generate eBooks (PDF & EPUB)

on:
  # Runs on pushes to main
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'docs/**/*.mdx'
      - 'scripts/generate-ebook.sh'
      - '.github/workflows/generate-ebooks.yml'

  # Allows manual triggering
  workflow_dispatch:

  # Weekly schedule (every Monday at 00:00 UTC)
  schedule:
    - cron: '0 0 * * 1'

permissions:
  contents: write

jobs:
  generate-ebooks:
    name: Generate PDF and EPUB
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Install Pandoc
        run: |
          echo "ğŸ“¦ Installing Pandoc and XeLaTeX..."
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-latex-extra

      - name: âœ… Verify Pandoc installation
        run: |
          echo "Pandoc version:"
          pandoc --version
          echo ""
          echo "XeLaTeX version:"
          xelatex --version

      - name: ğŸ“š Generate eBooks
        run: |
          chmod +x scripts/generate-ebook.sh
          bash scripts/generate-ebook.sh

      - name: ğŸ“Š List generated files
        run: |
          echo "Generated eBooks:"
          ls -lh ebooks/

      - name: ğŸ“¤ Upload PDF (Reading Version) as artifact
        uses: actions/upload-artifact@v4
        with:
          name: SICP-JS-PT-BR-PDF-Reading
          path: ebooks/SICP-JS-PT-BR.pdf
          retention-days: 90

      - name: ğŸ“¤ Upload PDF (Print Version) as artifact
        uses: actions/upload-artifact@v4
        with:
          name: SICP-JS-PT-BR-PDF-Print
          path: ebooks/SICP-JS-PT-BR-Print.pdf
          retention-days: 90

      - name: ğŸ“¤ Upload EPUB as artifact
        uses: actions/upload-artifact@v4
        with:
          name: SICP-JS-PT-BR-EPUB
          path: ebooks/SICP-JS-PT-BR.epub
          retention-days: 90

      - name: ğŸ·ï¸ Get current date for release tag
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          tag_name: ebook-${{ steps.date.outputs.date }}
          name: ğŸ“š eBooks - ${{ steps.date.outputs.date }}
          body: |
            ## ğŸ“š eBook Release - SICP.js PT-BR

            **Data de geraÃ§Ã£o**: ${{ steps.date.outputs.date }}

            ### ğŸ“¥ Downloads DisponÃ­veis

            - **PDF (Leitura)**: VersÃ£o otimizada para leitura em tela com cores e links clicÃ¡veis
            - **PDF (ImpressÃ£o)**: VersÃ£o otimizada para impressÃ£o em preto e branco
            - **EPUB**: CompatÃ­vel com e-readers (Kindle, Kobo, Apple Books, etc.)

            ### ğŸ“Š InformaÃ§Ãµes

            - Gerado automaticamente a partir dos arquivos markdown
            - Inclui todos os capÃ­tulos traduzidos atÃ© o momento
            - Tabela de conteÃºdos interativa
            - NumeraÃ§Ã£o de seÃ§Ãµes
            - CÃ³digo com syntax highlighting

            ### ğŸ¤ Como Contribuir

            Encontrou algum erro ou quer contribuir com a traduÃ§Ã£o? Acesse:
            - [RepositÃ³rio no GitHub](https://github.com/ibrahimcesar/estrutura-e-interpretacao-de-programas-de-computador-javascript)
            - [Guia de ContribuiÃ§Ã£o](https://github.com/ibrahimcesar/estrutura-e-interpretacao-de-programas-de-computador-javascript/blob/main/CONTRIBUTING.md)

            ---

            ğŸ“– **Leia online**: https://sicpjs.com/pt_BR/

            ğŸ¤– Gerado automaticamente via GitHub Actions
          files: |
            ebooks/SICP-JS-PT-BR.pdf
            ebooks/SICP-JS-PT-BR-Print.pdf
            ebooks/SICP-JS-PT-BR.epub
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ Add comment to commit (on push)
        if: github.event_name == 'push'
        uses: peter-evans/commit-comment@v3
        with:
          body: |
            ## ğŸ“š eBooks Gerados com Sucesso!

            Os eBooks foram gerados e estÃ£o disponÃ­veis nos artefatos desta execuÃ§Ã£o:

            - ğŸ“„ [PDF (Leitura)](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - ğŸ–¨ï¸ [PDF (ImpressÃ£o)](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - ğŸ“– [EPUB](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Os arquivos tambÃ©m foram incluÃ­dos em uma release no GitHub.
